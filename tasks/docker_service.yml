---
#### Docker Compose Service Users
- name: Manage Docker Compose Service users
  ansible.builtin.user:
    name: "{{ service_user.name }}"
    password: "{{ service_user.password | password_hash('sha512') }}"
    uid: "{{ service_user.uid }}"
    gid: "{{ service_user.gid }}"
    groups: "{{ service_user.groups | d(omit) }}"
    shell: "{{ service_user.shell | d(omit) }}"
  loop: "{{ _rpi_setup_docker_service.users | d(false, true) }}"
  loop_control:
    loop_var: service_user
  become: true


#### Docker Compose Service folders
- name: Manage Docker Compose Service project folder
  ansible.builtin.file:
    path: "{{ _rpi_setup_docker_service.project_path }}"
    state: directory
    owner: root
    group: root
    mode: 0750
  become: true

- name: Manage Docker Compose Service secrets folder
  ansible.builtin.file:
    path: "{{ _rpi_setup_docker_service.project_path }}/docker_secrets"
    state: directory
    owner: root
    group: root
    mode: 0750
  become: true
  when: _rpi_setup_docker_service.docker_secrets | d([], true) | selectattr('type', 'file') | length
  no_log: "{{ rpi_setup_nolog_override | d(true) }}"


#### Docker Compose Service secrets
- name: Manage Docker Compose Global Secrets (external)
  community.docker.docker_secret: "{{ docker_secret_external.configuration }}"
  loop: "{{ _rpi_setup_docker_service.docker_secrets | selectattr('type', 'external') }}"
  loop_control:
    loop_var: docker_secret_external
  become: true
  when: _rpi_setup_docker_service.docker_secrets | d([], true) | selectattr('type', 'external') | length
  no_log: "{{ rpi_setup_nolog_override | d(true) }}"

- name: Manage Docker Compose Service Secrets (file)
  ansible.builtin.copy:
    dest: "{{ _rpi_setup_docker_service.project_path }}/docker_secrets/{{ docker_secret_file.filename }}"
    content: |
      {{ docker_secret_file.content }}
    create: true
    owner: root
    group: root
    mode: 0640
  loop: "{{ _rpi_setup_docker_service.docker_secrets | selectattr('type', 'file') }}"
  loop_control:
    loop_var: docker_secret_file
  become: true
  when: _rpi_setup_docker_service.docker_secrets | d([], true) | selectattr('type', 'file') | length
  no_log: "{{ rpi_setup_nolog_override | d(true) }}"


#### Docker Compose Service environment
- name: Manage Docker Compose Service static env file
  ansible.builtin.copy:
    dest: "{{ _rpi_setup_docker_service.project_path }}/.env"
    content: |
      {{ _rpi_setup_docker_service.docker_env }}
    create: true
    owner: root
    group: root
    mode: 0640
  become: true
  when: _rpi_setup_docker_service.docker_env | d(false, true)
  no_log: "{{ rpi_setup_nolog_override | d(true) }}"

- name: Manage Docker Compose Service dynamic env script
  ansible.builtin.copy:
    dest: "{{ _rpi_setup_docker_service.project_path }}/dynamic_env.sh"
    content: |
      {{ _rpi_setup_docker_service.docker_dynamic_env }}
    create: true
    owner: root
    group: root
    mode: 0640
  become: true
  when: _rpi_setup_docker_service.docker_dynamic_env | d(false, true)
  no_log: "{{ rpi_setup_nolog_override | d(true) }}"


#### Docker Compose Service project
- name: Manage Docker Compose Service project file
  ansible.builtin.copy:
    dest: "{{ _rpi_setup_docker_service.project_path }}/docker-compose.yml"
    content: |
      ---
      {{ _rpi_setup_docker_service.configuration | to_nice_yaml(indent=2) }}
    create: true
    owner: root
    group: root
    mode: 0640
  become: true

- name: Manage Docker Compose Service systemd unit
  ansible.builtin.template:
    src: docker-service.service.j2
    dest: "/etc/systemd/system/docker-{{ _rpi_setup_docker_service.name }}.service"
    owner: root
    group: root
    mode: 0644
  become: true

- name: Manage Docker Compose Service systemd service
  ansible.builtin.systemd:
    name: "{{ _rpi_setup_docker_service.name }}"
    state: "{{ _rpi_setup_docker_service.state | d(omit) }}"
    enabled: "{{ _rpi_setup_docker_service.enabled | bool }}"
    daemon_reload: true
  become: true
